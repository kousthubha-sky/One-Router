# ============================================================
# GitHub Actions CI/CD Pipeline for OneRouter
# ============================================================
# Frontend: Vercel
# Backend: Render
# ============================================================

name: Deploy to Production

# ============================================================
# WHEN TO RUN
# ============================================================
on:
  push:
    branches: [main]

  # Manual trigger from GitHub Actions tab
  workflow_dispatch:

# ============================================================
# JOBS
# ============================================================
jobs:
  # ------------------------------------------------------------
  # JOB 1: Build and Test Frontend
  # ------------------------------------------------------------
  frontend:
    name: Frontend Checks
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./frontend

    # Environment variables needed for build
    env:
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
      NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build (includes type checking)
        run: npm run build

  # ------------------------------------------------------------
  # JOB 2: Build and Test Backend
  # ------------------------------------------------------------
  backend:
    name: Backend Checks
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Syntax check
        run: python -m py_compile app/main.py

  # ------------------------------------------------------------
  # JOB 3: Deploy Frontend to Vercel
  # ------------------------------------------------------------
  deploy-frontend:
    name: Deploy Frontend (Vercel)
    runs-on: ubuntu-latest
    needs: [frontend]  # Only deploy if checks pass

    steps:
      - name: Trigger Vercel Deploy
        run: |
          curl -X POST "${{ secrets.VERCEL_DEPLOY_HOOK }}"
        # Vercel deploy hook triggers a new deployment

  # ------------------------------------------------------------
  # JOB 4: Deploy Backend to Render
  # ------------------------------------------------------------
  deploy-backend:
    name: Deploy Backend (Render)
    runs-on: ubuntu-latest
    needs: [backend]  # Only deploy if checks pass

    steps:
      - name: Trigger Render Deploy
        run: |
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}"

# ============================================================
# SETUP INSTRUCTIONS
# ============================================================
#
# STEP 1: Get Vercel Deploy Hook
# ─────────────────────────────
# 1. Go to vercel.com → Your Project → Settings
# 2. Click "Git" in sidebar
# 3. Scroll to "Deploy Hooks"
# 4. Create hook: Name="GitHub Actions", Branch="main"
# 5. Copy the URL
#
# STEP 2: Get Render Deploy Hook
# ─────────────────────────────
# 1. Go to render.com → Your Backend Service → Settings
# 2. Find "Deploy Hook" section
# 3. Copy the URL
#
# STEP 3: Add Secrets to GitHub
# ─────────────────────────────
# 1. Go to GitHub → Your Repo → Settings
# 2. Click "Secrets and variables" → "Actions"
# 3. Click "New repository secret"
# 4. Add these secrets:
#
#    DEPLOY HOOKS:
#    Name: VERCEL_DEPLOY_HOOK
#    Value: https://api.vercel.com/v1/integrations/deploy/xxx
#
#    Name: RENDER_DEPLOY_HOOK
#    Value: https://api.render.com/deploy/srv-xxx?key=yyy
#
#    FRONTEND ENV VARS (for build):
#    Name: NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
#    Value: pk_live_xxxxx (from Clerk dashboard)
#
#    Name: NEXT_PUBLIC_API_URL
#    Value: https://your-backend-url.com
#
# ============================================================
# FLOW DIAGRAM
# ============================================================
#
#   git push main
#        │
#        ▼
#   ┌─────────────────────────┐
#   │   GitHub Actions Start  │
#   └───────────┬─────────────┘
#               │
#       ┌───────┴───────┐
#       ▼               ▼
#   Frontend         Backend
#   npm build        pip install
#   (parallel)       (parallel)
#       │               │
#       ▼               ▼
#   ✓ Pass?         ✓ Pass?
#       │               │
#       ▼               ▼
#   Deploy to       Deploy to
#   Vercel          Render
#
# ============================================================
